@startuml
'https://plantuml.com/class-diagram

class User
class UserGroup {
    users: Collection<User>
}

UserGroup *-- User : belongs to <

class Assignment {
    teachers: Collection<User | UserGroup>
    learners: Collection<User | UserGroup>
    sequences: List<Sequence>
}
note top
An assignment contains a list of learning sequence.
An assignment is managed by users registered as teachers.
An assignment is played by users registered as learners.
end note

Assignment "*" *- "*" User : registered as learner <
Assignment "*" *- "*" User : registered as teacher <
Assignment "*" *- "*" UserGroup : registered as learner <
Assignment "*" *- "*" UserGroup : registered as teacher <

Assignment *- activity.metamodel.Sequence : contains >

package scenario {
    abstract class Scenario
    note top
    The scenario is responsible for creating and updating ActivitySession.
    It will react to sequence updates and activity sessions events.
    end note

    class ManualScenario extends Scenario {
        createActivitySession()
        startActivitySession(sessionId)
        closeActivitySession(sessionId)
    }

    class AutomaticScenario extends Scenario

    abstract class ScenarioNode

    AutomaticScenario *-- AutomaticScenario : contains >
    AutomaticScenario "1" *-- "*" ScenarioNode : contains >
    ScenarioNode "0..1" *-- "1..*" ScenarioNode : descendants >

    abstract class TriggerNode extends ScenarioNode {
        watchers
    }
    note top
        Activated by external events
        (e.g. the 2nd phase of the sequence starts)
    end note

    abstract class BranchingNode extends ScenarioNode {
        branches: Map<Condition, ScenarioNode>
    }

    class IfNode extends BranchingNode
    class RangeNode extends BranchingNode

    abstract class ProcessingNode extends ScenarioNode
    note top
        Run a process
        without involving the learner
        (e.g., compute a pairing)
    end note

    abstract class ActivityNode extends ScenarioNode
    note top: Create and/or join activity session

    abstract class ConfigProvider
    abstract class MaterialProvider
    ActivityNode --> ConfigProvider
    ActivityNode --> MaterialProvider

    class StaticConfigProvider extends ConfigProvider
    class StaticMaterialProvider extends MaterialProvider
    abstract class SequenceMaterialProvider extends MaterialProvider

}

package activity.metamodel {
    class Sequence {
        state: State
        scenario: Scenario
        start()
        pause()
        resume()
        stop()
    }

    enum State {
        OPEN
        PENDING
        RUNNING
        CLOSED
    }

    Sequence --> State
    Sequence --> scenario.Scenario

    Scenario *- ActivitySession : Managed by <

    abstract class ActivitySession {
        context: Sequence
        activityConfig: ActivityConfig
        state: State
        activityCompleted: boolean
        abstract getLearners(): Collection<User>
        abstract getInputMaterial(): Collection<Material>
        abstract getLearnerOutput(): Collection<LearnerOutput>
    }

    class ActivitySessionLog

    ActivitySession --> State
    ActivitySession --> ActivitySessionLog
    ActivitySession --> ActivityConfig
    ActivitySession *-- LearnerOutput
    ActivitySession *-- Material


    interface ActivityConfig

    interface Material

    abstract class LearnerOutput extends Material {
        author: User
    }

    LearnerOutput -- User : Produced by >

    interface MaterialTransformer {
        supports(material: Material): boolean
        transform(material: Material): any
    }

}

package activity.response {
    class ResponseActivitySession extends activity.metamodel.ActivitySession {
        learner: User
        activityConfig: ResponseActivityConfig
        material: Question
        output: Response

        submitResponse()
    }

    class ChangeResponseActivitySession extends ResponseActivitySession {
        previousResponse: Response
        modifyResponse()
    }

    ResponseActivitySession --> User
    ResponseActivitySession --> Response
    ResponseActivitySession --> ResponseActivityConfig

    class ResponseActivityConfig implements activity.metamodel.ActivityConfig {
        provideConfidenceDegree: boolean
        provideExplanation: boolean
    }

    class Question implements activity.metamodel.Material {
        statement: String
        choices: List<Choice>
        correctionChoice: Choice
        explanatoryFeedback: String
    }

    class Response implements activity.metamodel.LearnerOutput {
        question: Question
        choice
        confidenceDegree
        explanation
    }

    Response --> Question
    Response --> User

    class ResponseScoreTransformer implements activity.metamodel.MaterialTransformer {
        transform(response: Response): Score
    }

    class ResponseCorrectnessTransformer implements activity.metamodel.MaterialTransformer {
        transform(response: Response): boolean
    }
}

package activity.judge {
    class JudgeActivitySession extends activity.metamodel.ActivitySession {
        learner: User
        activityConfig: ActivityConfig
        material: Collection<Material>
    }

    class JudgeActivityConfig extends activity.metamodel.ActivityConfig {

    }

    JudgeActivitySession --> User
    JudgeActivitySession --> JudgeActivityConfig
    JudgeActivitySession *-- Judgement
    JudgeActivitySession *-- activity.metamodel.Material

    class Judgement implements activity.metamodel.LearnerOutput {
        material: activity.metamodel.Material
        judgement

    }
    Judgement --> activity.metamodel.Material

}

package activity.chat {
    class ChatActivitySession extends activity.metamodel.ActivitySession {
        learners: Collection<User>
        topic: Material
    }

    ChatActivitySession *-- User
    ChatActivitySession --> activity.metamodel.Material
}

package activity.feedback {
    class GetFeedbackActivitySession extends activity.metamodel.ActivitySession {
        learner: User
    }

    GetFeedbackActivitySession --> User
}

package activity.generic {
    class WaitActivitySession extends activity.metamodel.ActivitySession
}
note top
A WaitActivitySession is used to make learners wait for an event to happen
before they can proceed to the next activity in the sequence.
end note
@enduml
