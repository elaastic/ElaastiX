services:
    postgres:
        image: postgres:18-alpine
        environment:
            POSTGRES_USER: elaastix
            POSTGRES_PASSWORD: elaastix
            POSTGRES_DATABASE: elaastix
        healthcheck:
            test: [ "CMD", "pg_isready",  "-U", "elaastix" ]
            interval: 5s
            timeout: 5s
            retries: 3
        ports:
            - "127.0.0.1:5432:5432"
        volumes:
            - pg-data:/var/lib/postgresql/data

    server:
        pull_policy: never
        image: elaastic/elaastix-server:local-develop
        build:
            context: .
            dockerfile: server/Containerfile
            target: base
        environment:
            SPRING_PROFILES_ACTIVE: develop,container
        command: bootRunDebug
        ports:
            - "127.0.0.1:8080:8080"
            - "127.0.0.1:55678:55678"
        volumes:
            - ./server/src:/build/server/src
        depends_on:
            postgres:
                condition: service_healthy

volumes:
    pg-data:
